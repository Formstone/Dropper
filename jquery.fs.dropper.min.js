/* 
 * Dropper v1.0.1 - 2014-10-29 
 * A jQuery plugin for simple drag and drop uploads. Part of the Formstone Library. 
 * http://formstone.it/dropper/ 
 * 
 * Copyright 2014 Ben Plum; MIT Licensed 
 */

!function(a,b){"use strict";function c(b){var c=a(this);if(p){b=a.extend({},J,b);for(var e=0,f=c.length;f>e;e++)d(c.eq(e),b)}return c}function d(b,c){c=a.extend({},c,b.data(o+"-options"));var d="";d+='<div class="'+r+'">',d+=J.label,d+="</div>",d+='<input class="'+s+'" type="file"',J.maxQueue>1&&(d+=" "+t),d+=">",b.addClass(q).append(d);var k=a.extend({$dropper:b,$input:b.find(n(s)),queue:[],total:0,uploading:!1},c);b.on(v,n(r),k,e).on(w,k,g).on(x,k,h).on(y,k,i).on(z,n(r),k,j).data(o,k),k.$input.on(A,k,f)}function e(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$input.trigger(v)}function f(a){a.stopPropagation(),a.preventDefault();var b=a.data,c=b.$input[0].files;c.length&&k(b,c)}function g(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.addClass(u)}function h(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.addClass(u)}function i(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.removeClass(u)}function j(a){a.preventDefault();var b=a.data,c=a.originalEvent.dataTransfer.files;b.$dropper.removeClass(u),k(b,c)}function k(c,d){for(var e=[],f=0;f<d.length;f++){var g={index:c.total++,file:d[f],name:d[f].name,size:d[f].size,started:!1,complete:!1,error:!1,transfer:null};e.push(g),c.queue.push(g)}c.uploading||(a(b).on(F,function(){return c.leave}),c.uploading=!0),c.$dropper.trigger(H,[e]),l(c)}function l(c){var d=0,e=[];for(var f in c.queue)!c.queue.hasOwnProperty(f)||c.queue[f].complete||c.queue[f].error||e.push(c.queue[f]);c.queue=e;for(var g in c.queue)if(c.queue.hasOwnProperty(g)){if(!c.queue[g].started){var h=new FormData;h.append(c.postKey,c.queue[g].file);for(var i in c.postData)c.postData.hasOwnProperty(i)&&h.append(i,c.postData[i]);m(c,c.queue[g],h)}if(d++,d>=c.maxQueue)return;f++}0===d&&(a(b).off(F),c.uploading=!1,c.$dropper.trigger(G))}function m(b,c,d){c.size>=b.maxSize?(c.error=!0,b.$dropper.trigger(B,[c,"Too large"]),l(b)):(c.started=!0,c.transfer=a.ajax({url:b.action,data:d,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var d=a.ajaxSettings.xhr();return d.upload&&d.upload.addEventListener(I,function(a){var d=0,e=a.loaded||a.position,f=a.total;a.lengthComputable&&(d=Math.ceil(e/f*100)),b.$dropper.trigger(D,[c,d])},!1),d},beforeSend:function(){b.$dropper.trigger(C,[c])},success:function(a){c.complete=!0,b.$dropper.trigger(E,[c,a]),l(b)},error:function(a,d,e){c.error=!0,b.$dropper.trigger(B,[c,e]),l(b)}}))}function n(a){return"."+a}var o="dropper",p=b.File&&b.FileReader&&b.FileList,q=o,r=o+"-dropzone",s=o+"-input",t=o+"-multiple",u=o+"-dropping",v="click."+o,w="dragenter."+o,x="dragover."+o,y="dragleave."+o,z="drop."+o,A="change."+o,B="fileError."+o,C="fileStart."+o,D="fileProgress."+o,E="fileComplete."+o,F="beforeunload."+o,G="complete."+o,H="start."+o,I="progress",J={action:"",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,postData:{},postKey:"file"},K={defaults:function(b){return J=a.extend(J,b||{}),a(this)}};a.fn[o]=function(a){return K[a]?K[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?this:c.apply(this,arguments)},a[o]=function(a){"defaults"===a&&K.defaults.apply(this,Array.prototype.slice.call(arguments,1))}}(jQuery,window);
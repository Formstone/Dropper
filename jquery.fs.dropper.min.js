/* 
 * Dropper v1.0.1 - 2014-12-11 
 * A jQuery plugin for simple drag and drop uploads. Part of the Formstone Library. 
 * http://formstone.it/dropper/ 
 * 
 * Copyright 2014 Ben Plum; MIT Licensed 
 */

!function(a,b){"use strict";function c(b){var c=a(this);if(o){b=a.extend({},p,b);for(var e=0,f=c.length;f>e;e++)d(c.eq(e),b)}return c}function d(b,c){c=a.extend({},c,b.data("dropper-options"));var d="";d+='<div class="dropper-dropzone">',d+=c.label,d+="</div>",d+='<input class="dropper-input" type="file"',c.maxQueue>1&&(d+=" multiple"),d+=">",b.addClass("dropper").append(d);var e=a.extend({$dropper:b,$input:b.find(".dropper-input"),queue:[],total:0,uploading:!1},c);b.on("click.dropper",".dropper-dropzone",e,f).on("dragenter.dropper",e,h).on("dragover.dropper",e,i).on("dragleave.dropper",e,j).on("drop.dropper",".dropper-dropzone",e,k).data("dropper",e),e.$input.on("change.dropper",e,g)}function e(a){a.find(".dropper-input").off("change.dropper",g),a.off("click.dropper",".dropper-dropzone",f).off("dragenter.dropper",h).off("dragover.dropper",i).off("dragleave.dropper",j).off("drop.dropper",".dropper-dropzone",k),a.removeClass("dropper").html("")}function f(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$input.trigger("click")}function g(a){a.stopPropagation(),a.preventDefault();var b=a.data,c=b.$input[0].files;c.length&&l(b,c)}function h(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.addClass("dropping")}function i(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.addClass("dropping")}function j(a){a.stopPropagation(),a.preventDefault();var b=a.data;b.$dropper.removeClass("dropping")}function k(a){a.preventDefault();var b=a.data,c=a.originalEvent.dataTransfer.files;b.$dropper.removeClass("dropping"),l(b,c)}function l(c,d){for(var e=[],f=0;f<d.length;f++){var g={index:c.total++,file:d[f],name:d[f].name,size:d[f].size,started:!1,complete:!1,error:!1,transfer:null};e.push(g),c.queue.push(g)}c.uploading||(a(b).on("beforeunload.dropper",function(){return"You have uploads pending, are you sure you want to leave this page?"}),c.uploading=!0),c.$dropper.trigger("start.dropper",[e]),m(c)}function m(c){var d=0,e=[];for(var f in c.queue)!c.queue.hasOwnProperty(f)||c.queue[f].complete||c.queue[f].error||e.push(c.queue[f]);c.queue=e;for(var g in c.queue)if(c.queue.hasOwnProperty(g)){if(!c.queue[g].started){var h=new FormData;h.append(c.postKey,c.queue[g].file);for(var i in c.postData)c.postData.hasOwnProperty(i)&&h.append(i,c.postData[i]);n(c,c.queue[g],h)}if(d++,d>=c.maxQueue)return;f++}0===d&&(a(b).off("beforeunload.dropper"),c.uploading=!1,c.$dropper.trigger("complete.dropper"))}function n(b,c,d){c.size>=b.maxSize?(c.error=!0,b.$dropper.trigger("fileError.dropper",[c,"Too large"]),m(b)):(c.started=!0,c.transfer=a.ajax({url:b.action,data:d,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var d=a.ajaxSettings.xhr();return d.upload&&d.upload.addEventListener("progress",function(a){var d=0,e=a.loaded||a.position,f=a.total;a.lengthComputable&&(d=Math.ceil(e/f*100)),b.$dropper.trigger("fileProgress.dropper",[c,d])},!1),d},beforeSend:function(){b.$dropper.trigger("fileStart.dropper",[c])},success:function(a){c.complete=!0,b.$dropper.trigger("fileComplete.dropper",[c,a]),m(b)},error:function(a,d,e){c.error=!0,b.$dropper.trigger("fileError.dropper",[c,e]),m(b)}}))}var o=b.File&&b.FileReader&&b.FileList,p={action:"",label:"Drag and drop files or click to select",maxQueue:2,maxSize:5242880,postData:{},postKey:"file"},q={destroy:function(){for(var b=a(this),c=0,d=b.length;d>c;c++)e(b.eq(c));return"object"==typeof this?a(this):!0},defaults:function(b){return p=a.extend(p,b||{}),"object"==typeof this?a(this):!0}};a.fn.dropper=function(a){return q[a]?q[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?this:c.apply(this,arguments)},a.dropper=function(a){"defaults"===a&&q.defaults.apply(this,Array.prototype.slice.call(arguments,1))}}(jQuery,window);